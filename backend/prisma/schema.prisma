generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./data/bookmarker.dev.db"
}

model User {
  id           Int        @id @default(autoincrement())
  username     String     @unique
  email        String     @unique
  passwordHash String     @map("password_hash")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")
  bookmarks    Bookmark[]
  tags         Tag[]
  apiTokens    ApiToken[]
  auditLogs    AuditLog[]

  @@map("users")
}

model Bookmark {
  id          Int           @id @default(autoincrement())
  userId      Int           @map("user_id")
  path        String // URL or file path (unified)
  title       String
  description String?
  isFavorite  Boolean       @default(false) @map("is_favorite")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  tags        BookmarkTag[]

  @@map("bookmarks")
}

model Tag {
  id         Int           @id @default(autoincrement())
  userId     Int           @map("user_id")
  name       String
  isFavorite Boolean       @default(false) @map("is_favorite")
  createdAt  DateTime      @default(now()) @map("created_at")
  user       User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookmarks  BookmarkTag[]

  @@unique([userId, name])
  @@map("tags")
}

model BookmarkTag {
  bookmarkId Int      @map("bookmark_id")
  tagId      Int      @map("tag_id")
  bookmark   Bookmark @relation(fields: [bookmarkId], references: [id], onDelete: Cascade)
  tag        Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([bookmarkId, tagId])
  @@map("bookmark_tags")
}

model ApiToken {
  id         Int       @id @default(autoincrement())
  userId     Int       @map("user_id")
  tokenHash  String    @unique @map("token_hash")
  name       String
  lastUsedAt DateTime? @map("last_used_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  expiresAt  DateTime? @map("expires_at")
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("api_tokens")
}

model AuditLog {
  id           Int      @id @default(autoincrement())
  timestamp    DateTime @default(now())
  userId       Int?     @map("user_id")
  action       String
  resourceType String?  @map("resource_type")
  resourceId   Int?     @map("resource_id")
  severity     String   @default("LOW")
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  requestId    String?  @map("request_id")
  details      Json?
  outcome      String
  user         User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([timestamp])
  @@index([userId])
  @@index([action])
  @@index([severity])
  @@map("audit_logs")
}
