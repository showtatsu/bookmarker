---
name: ci-cd
description: 'CI/CD Pipeline Design for Bookmarker Application'
status: accepted
---

## タイトル
CI/CDパイプラインの設計

## 概要
Bookmarkerアプリケーションにおける継続的インテグレーション/継続的デリバリー（CI/CD）パイプラインの設計に関する決定事項です。

## 背景
コードの品質を維持し、安全かつ迅速にデプロイするために、自動化されたCI/CDパイプラインが必要です。

## 決定事項

### CI/CDプラットフォーム: GitHub Actions

- **選定理由**:
  - GitHubリポジトリとの統合が容易
  - 無料枠が十分（パブリックリポジトリ無制限、プライベート2,000分/月）
  - YAMLベースの設定
  - マーケットプレイスに豊富なアクション

### ワークフロー構成

#### 1. CI ワークフロー（Pull Request時）

```yaml
# .github/workflows/ci.yml
name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
      - run: npm ci
      - run: npm run lint

  test-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
      - run: cd backend && npm ci
      - run: cd backend && npm run test:coverage
      - uses: codecov/codecov-action@v4
        with:
          files: backend/coverage/lcov.info

  test-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
      - run: cd frontend && npm ci
      - run: cd frontend && npm run test:coverage

  e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
      - run: npm ci
      - run: npx playwright install --with-deps
      - run: npm run test:e2e
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: playwright-report/
```

#### 2. Build & Push ワークフロー（mainブランチマージ時）

```yaml
# .github/workflows/build.yml
name: Build and Push

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ghcr.io/${{ github.repository }}/backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build and push frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ghcr.io/${{ github.repository }}/frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
```

#### 3. Release ワークフロー（タグ作成時）

```yaml
# .github/workflows/release.yml
name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
```

### ブランチ戦略

```
main ← feature/xxx
     ← fix/xxx
     ← docs/xxx
```

- **main**: 常にデプロイ可能な状態
- **feature/xxx**: 新機能開発
- **fix/xxx**: バグ修正
- **docs/xxx**: ドキュメント更新

### Pull Request ルール

- CIが全て成功していること（必須）
- 最低1人のレビュー承認（推奨、個人開発時は省略可）
- コンフリクトがないこと

### セマンティックバージョニング

- **MAJOR**: 破壊的変更
- **MINOR**: 後方互換性のある機能追加
- **PATCH**: 後方互換性のあるバグ修正

```
v1.0.0 → v1.0.1 (バグ修正)
       → v1.1.0 (機能追加)
       → v2.0.0 (破壊的変更)
```

### シークレット管理

| シークレット名 | 用途 |
|---------------|------|
| GITHUB_TOKEN | 自動提供、GHCR へのプッシュ |
| CODECOV_TOKEN | カバレッジレポート送信（オプション） |

## 代替案

| 案 | 利点 | 欠点 | 判断 |
|---|---|---|---|
| GitHub Actions（採用） | GitHub統合、無料枠大 | YAMLが冗長になりがち | 最適 |
| GitLab CI | 統合機能が豊富 | GitHubからの移行コスト | 不採用 |
| CircleCI | 高速、設定しやすい | 無料枠が少ない | 不採用 |

## 結果
GitHub Actionsにより、PRごとの自動テストとmainブランチへのマージ時の自動ビルドが実現できます。

## 関連ドキュメント
- [ADR-0007: デプロイメント戦略](0007-deployment.md)
- [ADR-0008: テスト戦略](0008-testing.md)
