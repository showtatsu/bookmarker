# ADR 0016: データマイグレーション戦略

## ステータス

承認済み

## コンテキスト

Prismaを使用したデータベースマイグレーション時に、以下の課題が発生する可能性がある：

1. **SQLiteの制限**: SQLiteはALTER TABLEの機能が限定的で、カラム追加時にテーブル再作成が必要になることがある
2. **データ消失リスク**: マイグレーション中のエラーや不適切な操作でデータが消失する可能性
3. **環境間の差異**: 開発・テスト・本番環境で異なるデータベース状態が発生しうる
4. **ロールバックの困難さ**: Prismaのマイグレーションは基本的に前進のみで、ロールバックが自動化されていない

## 決定

### 1. マイグレーション前のバックアップ必須化

すべてのマイグレーション実行前に、データベースのバックアップを作成する。

```bash
# SQLiteの場合
cp prisma/data/bookmarker.dev.db prisma/data/bookmarker.dev.db.backup.$(date +%Y%m%d_%H%M%S)
```

### 2. マイグレーションスクリプトの標準化

`backend/scripts/migrate.sh` スクリプトを使用して、安全なマイグレーションを実行する。

### 3. データシード機能の整備

開発環境では `prisma/seed.ts` を使用して、初期データを投入できるようにする。

### 4. マイグレーション検証の実施

マイグレーション後に、データの整合性を検証するスクリプトを実行する。

## マイグレーション手順

### 通常のマイグレーション

```bash
# 1. バックアップ作成
npm run db:backup

# 2. マイグレーション実行
npm run db:migrate

# 3. 検証
npm run db:verify
```

### データを含むマイグレーション

既存データの変換が必要な場合：

1. マイグレーションSQLを事前に確認: `npx prisma migrate dev --create-only`
2. 必要に応じてSQLを手動編集
3. マイグレーション実行: `npx prisma migrate dev`

## 実装

### バックアップスクリプト

`backend/scripts/backup-db.sh` - データベースのバックアップを作成

### マイグレーションスクリプト

`backend/scripts/migrate.sh` - バックアップ付きマイグレーション

### 検証スクリプト

`backend/scripts/verify-db.ts` - マイグレーション後のデータ検証

## 影響

### ポジティブ

- データ消失リスクの軽減
- マイグレーション手順の標準化
- 問題発生時の復旧が容易

### ネガティブ

- マイグレーション手順が若干複雑化
- バックアップファイルによるディスク使用量増加

## 関連ADR

- ADR 0003: データベース設計
- ADR 0012: 開発環境

## 改訂履歴

- 2026-01-18: 初版作成
